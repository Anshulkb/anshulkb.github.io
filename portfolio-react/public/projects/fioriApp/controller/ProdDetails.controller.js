sap.ui.define(["sap/dashboard/controller/BaseController","sap/dashboard/model/Formatter","sap/m/GenericTag","sap/m/Image","sap/ui/core/BusyIndicator","sap/m/MessageBox"],function(e,t,o,s,r,a){"use strict";return e.extend("sap.dashboard.controller.ProdDetails",{formatter:t,onInit(){this.getView().addEventDelegate({onBeforeShow:function(e){this._onBeforeShow(e.data.id)}.bind(this)})},_onBeforeShow(e){this.getOwnerComponent().getModel("mainModel").setProperty("/sPageTitle","Product Details");this.setDefaultData();this.getProdDetails(e)},goBackToProducts(){this.getView().getModel("oProdDetModel").setData({});this.getNavContainer().back()},setDefaultData(){const e=this.getOwnerComponent().getModel("prodDetailModel");this.getView().setModel(e,"oProdDetModel")},async getProdDetails(e){const t=this.getView().getModel("oProdDetModel");try{r.show(0);const o=`/api/products?id=${e}`;const s=await fetch(o);if(!s.ok){throw new Error(`HTTP error ${s.status}`)}const a=await s.json();if(typeof a!=="object"){throw new Error(`Invalid format for product details.`)}const i={...a,userRating:0,userComment:"",reviewPresent:false,fProdImg:""};i.rating=Number(i.rating.toFixed(1));t.setData(i);this.bindTags();this.checkUserReview();this.setDefautImg()}catch(e){a.error("Unable to fetch Product details.",{details:e.message,onClose:()=>{this.goBackToProducts()}})}finally{r.hide()}},bindTags(){const e=this.getView().byId("idGenTagContainer");if(e.getItems().length>0){e.removeAllItems()}const t=this.getView().getModel("oProdDetModel").getProperty("/tags")??[];t.forEach(t=>{const s=new o({text:t.charAt(0).toUpperCase()+t.substring(1)});s.addStyleClass("sapUiSmallMarginEnd");s.addStyleClass("sapUiTinyMarginBottom");s.addStyleClass("genericTagStyle");e.addItem(s)})},onImagePress(e){const t=this.getView().getModel("oProdDetModel");const o=this.getView().byId("idImgContainer");const s=o.getItems();const r=e.getSource();const a=r.getId();const i=r.getBindingContext("oProdDetModel").getPath();const n=t.getProperty(i);s.forEach(e=>{e.toggleStyleClass("selectImg",e.sId===a)});t.setProperty("/fProdImg",n)},onAddReviewPress(){this.checkUserReview();this.createFragment("sap.dashboard.fragment.ReviewDialog")},navToReviews(){const e=this.getView().byId("idProdDetPage");const t=this.getView().byId("idReviewList");e.scrollToElement(t)},async createFragment(e){this._oDialog??=await this.loadFragment({name:e,controller:this});this.openDialog()},openDialog(){this._oDialog.open()},closeDialog(){this._oDialog.close();this._oDialog.destroy();this._oDialog=null},onCancelReviewDialog(){const e=this.getView().getModel("oProdDetModel");e.setProperty("/userRating",0);e.setProperty("/userComment","");this.closeDialog()},showBarcode(){const e=this.getView().getModel("oProdDetModel");const t=e.getProperty("/meta/barcode");const o=document.createElement("canvas");if(window.JsBarcode){try{JsBarcode(o,t,{format:"CODE128",displayValue:true,lineColor:"#000",height:60,width:2,fontSize:14});const s=o.toDataURL("image/png");e.setProperty("/code",s);this.createFragment("sap.dashboard.fragment.ImageDialog")}catch(e){this.showMessageBox(String(e.message))}}else{this.showMessageBox("Unable to load libraries.\nPlease refresh the page and try again.")}},showQrcode(){const e=this.getView().getModel("oProdDetModel");const t=e.getProperty("/meta/qrCode");e.setProperty("/code",t);this.createFragment("sap.dashboard.fragment.ImageDialog")},onSaveReviewDialog(){const e=this.getView().getModel("oProdDetModel");const t=e.getProperty("/userRating");const o=e.getProperty("/userComment").trim();const s=e.getProperty("/reviews");if(!t){this.showMessageBox("error","Please provide a rating.");return}try{r.show(0);const a=(new Date).toISOString();const i=s.find(e=>e.reviewerName==="Anonymous User");if(i){Object.assign(i,{rating:t,comment:o,date:a})}else{s.unshift({rating:t,comment:o,date:a,reviewerName:"Anonymous User",reviewerEmail:"anonymous@test.com"})}e.setProperty("/reviews",s);e.setProperty("/reviewPresent",true);this.closeDialog()}catch(e){this.showMessageBox(String(e.message))}finally{r.hide()}},checkUserReview(){const e=this.getView().getModel("oProdDetModel");const t=e.getProperty("/reviews")??[];const o=t.find(e=>e.reviewerName==="Anonymous User");if(o){e.setProperty("/userRating",o.rating);e.setProperty("/userComment",o.comment);e.setProperty("/reviewPresent",true)}},setDefautImg(){const e=this.getView().byId("idImgContainer");const t=e.getItems();t[0].addStyleClass("selectImg");this.getView().getModel("oProdDetModel").setProperty("/fProdImg",t[0].getProperty("src"))}})});
//# sourceMappingURL=ProdDetails.controller.js.map